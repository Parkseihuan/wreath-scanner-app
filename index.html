<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÌôîÌôò Î¨∏Íµ¨ Ïù∏Ïãù Ïï±</title>
    <meta name="description" content="ÌôîÌôò Î¨∏Íµ¨Î•º ÏûêÎèôÏúºÎ°ú Ïù∏ÏãùÌïòÏó¨ Íµ¨Í∏Ä Ïä§ÌîÑÎ†àÎìúÏãúÌä∏Ïóê Ï†ÄÏû•">
    
    <!-- 
    ==========================================
    üõ†Ô∏è Í¥ÄÎ¶¨Ïûê ÏÑ§Ï†ï Í∞ÄÏù¥Îìú 
    ==========================================
    
    üìã 1Îã®Í≥Ñ: Google Ïä§ÌîÑÎ†àÎìúÏãúÌä∏ ÏÉùÏÑ±
    - ÏÉà Íµ¨Í∏Ä Ïä§ÌîÑÎ†àÎìúÏãúÌä∏ ÏÉùÏÑ±
    - ÌååÏùºÎ™Ö: "ÌôîÌôò Î¨∏Íµ¨ Í∏∞Î°ù"
    
    üìã 2Îã®Í≥Ñ: Apps Script ÏÑ§Ï†ï
    - Ïä§ÌîÑÎ†àÎìúÏãúÌä∏ÏóêÏÑú "ÌôïÏû• ÌîÑÎ°úÍ∑∏Îû®" > "Apps Script" ÌÅ¥Î¶≠
    - Í∏∞Ï°¥ ÏΩîÎìú Î™®Îëê ÏÇ≠Ï†ú
    - Ï†úÍ≥µÎêú code.gs ÌååÏùº ÎÇ¥Ïö© Ï†ÑÏ≤¥ Î≥µÏÇ¨ & Î∂ôÏó¨ÎÑ£Í∏∞
    - Ctrl+SÎ°ú Ï†ÄÏû•
    
    üìã 3Îã®Í≥Ñ: ÏõπÏï± Î∞∞Ìè¨
    - "Î∞∞Ìè¨" > "ÏÉà Î∞∞Ìè¨" ÌÅ¥Î¶≠
    - Ïú†Ìòï: "Ïõπ Ïï±" ÏÑ†ÌÉù
    - ÏÑ§Î™Ö: "ÌôîÌôò Î¨∏Íµ¨ Ïù∏Ïãù Ïï±"
    - Ïã§Ìñâ Í∂åÌïú: "ÎÇò"
    - Ïï°ÏÑ∏Ïä§ Í∂åÌïú: "Î™®Îì† ÏÇ¨Ïö©Ïûê" ‚≠ê Ï§ëÏöî!
    - "Î∞∞Ìè¨" ÌÅ¥Î¶≠
    - ÏõπÏï± URL Î≥µÏÇ¨ (Ïòà: https://script.google.com/macros/s/AKfycbx.../exec)
    
    üìã 4Îã®Í≥Ñ: Ïù¥ ÌååÏùº ÏàòÏ†ï
    - ÏïÑÎûò JavaScript ÏΩîÎìúÏóêÏÑú WEBAPP_URL Î≥ÄÏàòÎ•º 
      Ïã§Ï†ú ÏõπÏï± URLÎ°ú Î≥ÄÍ≤ΩÌïòÏÑ∏Ïöî!
    
    üîß Î¨∏Ï†ú Ìï¥Í≤∞:
    - "Ïó∞Í≤∞ ÌÖåÏä§Ìä∏" Î≤ÑÌäºÏúºÎ°ú ÏÑ§Ï†ï ÌôïÏù∏ Í∞ÄÎä•
    - Î∏åÎùºÏö∞Ï†Ä Í∞úÎ∞úÏûê ÎèÑÍµ¨(F12) > ConsoleÏóêÏÑú Ïò§Î•ò ÌôïÏù∏
    - Apps Script > Ïã§Ìñâ ÎÇ¥Ïó≠ÏóêÏÑú Î°úÍ∑∏ ÌôïÏù∏
    
    ==========================================
    -->
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="ÌôîÌôò Î¨∏Íµ¨ Ïù∏Ïãù">
    
    <!-- ÌååÎπÑÏΩò -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üå∏</text></svg>">
    
    <!-- Tesseract.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.1.1/tesseract.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 8px;
            margin: 0;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .container {
            max-width: 420px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff6b6b, #ffd93d);
            color: white;
            padding: 16px;
            text-align: center;
        }

        .header h1 {
            font-size: 22px;
            margin-bottom: 6px;
            font-weight: 700;
        }

        .header p {
            font-size: 13px;
            opacity: 0.9;
        }

        .content {
            padding: 16px;
        }

        .camera-container {
            position: relative;
            width: 100%;
            margin: 0 auto 20px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 6px 20px rgba(0,0,0,0.12);
            background: #f8f9fa;
            min-height: 280px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #video {
            width: 100%;
            height: auto;
            display: block;
            max-height: 400px;
            object-fit: cover;
        }

        #capturedImage {
            width: 100%;
            height: auto;
            display: none;
            max-height: 400px;
            object-fit: contain;
        }

        #canvas {
            display: none;
        }

        .camera-placeholder {
            text-align: center;
            color: #6c757d;
            padding: 40px 20px;
        }

        .camera-placeholder .icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        button {
            padding: 14px 24px;
            border: none;
            border-radius: 28px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            position: relative;
            overflow: hidden;
            min-height: 50px;
        }

        button:active {
            transform: scale(0.96);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover {
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        .btn-success:hover {
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
        }

        .btn-secondary:hover {
            box-shadow: 0 6px 20px rgba(108, 117, 125, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107, #fd7e14);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
        }

        .btn-warning:hover {
            box-shadow: 0 6px 20px rgba(255, 193, 7, 0.4);
        }

        /* Í≥†Ï†ï ÌïòÎã® Ïª®Ìä∏Î°§ */
        .fixed-controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(255,255,255,0.98), rgba(255,255,255,0.95));
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 16px;
            border-top: 1px solid rgba(0,0,0,0.1);
            z-index: 1000;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
        }

        .fixed-controls .controls {
            max-width: 420px;
            margin: 0 auto;
            margin-bottom: 0;
        }

        /* ÌïòÎã® Ïª®Ìä∏Î°§ÏùÑ ÏúÑÌïú Ïó¨Î∞± */
        .content-with-fixed-controls {
            margin-bottom: 100px;
        }

        .status {
            text-align: center;
            padding: 12px;
            margin: 12px 0;
            border-radius: 10px;
            font-weight: 500;
            font-size: 14px;
        }

        .status.processing {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .result-section {
            background: #f8f9fa;
            padding: 18px;
            border-radius: 12px;
            margin: 18px 0;
            border: 1px solid #e9ecef;
        }

        .result-section h3 {
            color: #495057;
            margin-bottom: 16px;
            text-align: center;
            font-size: 17px;
        }

        .form-group {
            margin-bottom: 14px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #495057;
            font-size: 14px;
        }

        input, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 14px;
            font-family: inherit;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            transition: border-color 0.3s ease;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea {
            height: 70px;
            resize: vertical;
            min-height: 50px;
        }

        .data-list {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-top: 18px;
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
        }

        .data-list h3 {
            color: #495057;
            margin-bottom: 12px;
            text-align: center;
            font-size: 16px;
        }

        .data-item {
            background: #f8f9fa;
            padding: 12px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            font-size: 13px;
        }

        .connection-test {
            text-align: center;
            padding: 16px;
            margin-top: 12px;
        }

        .connection-test button {
            width: 100%;
            max-width: 280px;
        }

        .loading {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        .footer {
            text-align: center;
            padding: 16px;
            color: #6c757d;
            font-size: 12px;
            border-top: 1px solid #e9ecef;
        }

        /* OCR ÌíàÏßà Ìñ•ÏÉÅ ÌåÅ */
        .ocr-tips {
            background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
            padding: 16px;
            border-radius: 12px;
            margin: 16px 0;
            border: 1px solid #bbdefb;
        }

        .ocr-tips h4 {
            color: #1976d2;
            margin-bottom: 8px;
            font-size: 15px;
        }

        .ocr-tips ul {
            margin: 0;
            padding-left: 16px;
            color: #424242;
            font-size: 13px;
            line-height: 1.4;
        }

        .ocr-tips li {
            margin-bottom: 4px;
        }

        /* Î™®Î∞îÏùº ÏµúÏ†ÅÌôî */
        @media (max-width: 480px) {
            body {
                padding: 4px;
            }
            
            .container {
                margin: 4px;
                border-radius: 12px;
            }
            
            .header {
                padding: 14px;
            }
            
            .content {
                padding: 14px;
            }
            
            button {
                min-width: 110px;
                font-size: 14px;
                padding: 12px 20px;
                min-height: 48px;
            }
            
            .controls {
                gap: 10px;
            }

            .camera-container {
                min-height: 250px;
            }

            .fixed-controls {
                padding: 12px;
            }
        }

        /* Ï¥àÏÜåÌòï ÌôîÎ©¥ */
        @media (max-width: 350px) {
            button {
                min-width: 100px;
                font-size: 13px;
                padding: 10px 16px;
                min-height: 44px;
            }
        }

        /* iOS ÏÇ¨ÌååÎ¶¨ ÏµúÏ†ÅÌôî */
        @supports (-webkit-touch-callout: none) {
            .camera-container {
                -webkit-overflow-scrolling: touch;
            }
            
            input, textarea {
                -webkit-appearance: none;
                border-radius: 10px;
            }

            .fixed-controls {
                padding-bottom: calc(16px + env(safe-area-inset-bottom));
            }
        }

        /* Îã§ÌÅ¨Î™®Îìú ÎåÄÏùë */
        @media (prefers-color-scheme: dark) {
            .camera-placeholder {
                color: #8e9aaf;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>üå∏ ÌôîÌôò Î¨∏Íµ¨ Ïù∏Ïãù Ïï±</h1>
            <p>ÌôîÌôòÏùÑ Ï¥¨ÏòÅÌïòÏó¨ ÏûêÎèôÏúºÎ°ú Î¨∏Íµ¨Î•º Ïù∏ÏãùÌïòÍ≥† Í∏∞Î°ùÌï©ÎãàÎã§</p>
        </header>
        
        <main class="content content-with-fixed-controls">
            <!-- Ïπ¥Î©îÎùº -->
            <section class="camera-section">
                <div class="camera-container" id="cameraContainer">
                    <div class="camera-placeholder">
                        <div class="icon">üì∑</div>
                        <p>Ïπ¥Î©îÎùºÎ•º ÏãúÏûëÌïòÎ†§Î©¥<br>ÏïÑÎûò Î≤ÑÌäºÏùÑ ÎàåÎü¨Ï£ºÏÑ∏Ïöî</p>
                    </div>
                    <video id="video" autoplay playsinline></video>
                    <img id="capturedImage" alt="Ï¥¨ÏòÅÎêú Ïù¥ÎØ∏ÏßÄ" />
                    <canvas id="canvas"></canvas>
                </div>

                <!-- OCR ÌíàÏßà Ìñ•ÏÉÅ ÌåÅ -->
                <div class="ocr-tips">
                    <h4>üìù Ïù∏ÏãùÎ•† Ìñ•ÏÉÅ ÌåÅ</h4>
                    <ul>
                        <li>Î∞ùÏùÄ Í≥≥ÏóêÏÑú Ï¥¨ÏòÅÌïòÏÑ∏Ïöî</li>
                        <li>ÌôîÌôò Î¶¨Î≥∏Ïù¥ ÌôîÎ©¥ Ï§ëÏïôÏóê Ïò§ÎèÑÎ°ù ÌïòÏÑ∏Ïöî</li>
                        <li>Ïπ¥Î©îÎùºÏôÄ Î¶¨Î≥∏Ïù¥ ÏàòÏßÅÏù¥ ÎêòÎèÑÎ°ù ÌïòÏÑ∏Ïöî</li>
                        <li>Í∏ÄÏûêÍ∞Ä ÏÑ†Î™ÖÌïòÍ≤å Î≥¥Ïù¥ÎèÑÎ°ù Í∞ÄÍπåÏù¥ Ï¥¨ÏòÅÌïòÏÑ∏Ïöî</li>
                        <li>Í∑∏Î¶ºÏûêÍ∞Ä ÏóÜÎäî Í≥≥ÏóêÏÑú Ï¥¨ÏòÅÌïòÏÑ∏Ïöî</li>
                    </ul>
                </div>
            </section>

            <!-- Ïó∞Í≤∞ ÌÖåÏä§Ìä∏ -->
            <section class="connection-test">
                <button class="btn-secondary" onclick="testConnection()">üîß Ïó∞Í≤∞ ÌÖåÏä§Ìä∏</button>
            </section>

            <!-- ÏÉÅÌÉú -->
            <div id="status" class="status hidden"></div>

            <!-- Í≤∞Í≥º -->
            <section id="resultSection" class="result-section hidden">
                <h3>üìù Ïù∏ÏãùÎêú ÌôîÌôò Î¨∏Íµ¨</h3>
                <div class="form-group">
                    <label for="leftRibbon">Ï¢åÏ∏° Î¶¨Î≥∏ Î¨∏Íµ¨:</label>
                    <textarea id="leftRibbon" placeholder="Ï¢åÏ∏° Î¶¨Î≥∏ÏóêÏÑú Ïù∏ÏãùÎêú Î¨∏Íµ¨"></textarea>
                </div>
                <div class="form-group">
                    <label for="rightRibbon">Ïö∞Ï∏° Î¶¨Î≥∏ Î¨∏Íµ¨:</label>
                    <textarea id="rightRibbon" placeholder="Ïö∞Ï∏° Î¶¨Î≥∏ÏóêÏÑú Ïù∏ÏãùÎêú Î¨∏Íµ¨"></textarea>
                </div>
                <div class="form-group">
                    <label for="recognizedText">Ï†ÑÏ≤¥ Ïù∏Ïãù ÌÖçÏä§Ìä∏:</label>
                    <textarea id="recognizedText" placeholder="Ïù∏ÏãùÎêú Ï†ÑÏ≤¥ ÌÖçÏä§Ìä∏"></textarea>
                </div>
                <div class="controls">
                    <button class="btn-success" onclick="saveToSheets()">üíæ Ïä§ÌîÑÎ†àÎìúÏãúÌä∏Ïóê Ï†ÄÏû•</button>
                </div>
            </section>

            <!-- Ï†ÄÏû•Îêú Îç∞Ïù¥ÌÑ∞ -->
            <section class="data-list">
                <h3>üíæ ÏµúÍ∑º Ï†ÄÏû•Îêú Îç∞Ïù¥ÌÑ∞</h3>
                <div id="savedItems"></div>
            </section>
        </main>

        <!-- Í≥†Ï†ï ÌïòÎã® Ïª®Ìä∏Î°§ -->
        <div class="fixed-controls">
            <div class="controls">
                <button id="startCameraBtn" class="btn-primary" onclick="startCamera()">üì∑ Ïπ¥Î©îÎùº ÏãúÏûë</button>
                <button id="captureBtn" class="btn-success hidden" onclick="captureImage()">üì∏ Ï¥¨ÏòÅÌïòÍ∏∞</button>
                <button id="retakeBtn" class="btn-warning hidden" onclick="retakePhoto()">üîÑ Îã§Ïãú Ï¥¨ÏòÅ</button>
                <button id="enhanceBtn" class="btn-warning hidden" onclick="enhanceAndRecognize()">‚ú® Ïù∏Ïãù Ìñ•ÏÉÅ</button>
            </div>
        </div>

        <footer class="footer">
            <p>üå∏ ÌôîÌôò Î¨∏Íµ¨ Ïù∏Ïãù Ïï± v2.0 - Ïù∏ÏãùÎ•† Í∞úÏÑ† Î≤ÑÏ†Ñ</p>
        </footer>
    </div>

    <script>
        // ==========================================
        // üîß Í¥ÄÎ¶¨Ïûê ÏÑ§Ï†ï - ÏïÑÎûò URLÏùÑ Î≥ÄÍ≤ΩÌïòÏÑ∏Ïöî!
        // ==========================================
        const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbynsYiZLDH2m46fsyGqhZRQv7ykrEWsDzH0xHaQ4dBJtOoR-EBzf0KAU5rCWwWUBESlCw/exec';
        
        let video = document.getElementById('video');
        let canvas = document.getElementById('canvas');
        let capturedImage = document.getElementById('capturedImage');
        let ctx = canvas.getContext('2d');
        let savedData = [];
        let currentStream = null;
        let isProcessing = false;

        // Ï¥àÍ∏∞Ìôî (ÏûêÎèô Ïó∞Í≤∞ ÌôïÏù∏)
        window.onload = function() {
            loadSavedData();
            
            // ÏûêÎèôÏúºÎ°ú Ïó∞Í≤∞ ÌÖåÏä§Ìä∏ Ïã§Ìñâ (Ï°∞Ïö©Ìûà)
            setTimeout(async () => {
                try {
                    const response = await fetch(WEBAPP_URL, {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' },
                        mode: 'cors'
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            console.log('‚úÖ ÏõπÏï± Ïó∞Í≤∞ ÌôïÏù∏Îê®:', result.sheetName);
                            showStatus(`‚úÖ ÌôîÌôò Ïù∏Ïãù Ïï±Ïù¥ Ï§ÄÎπÑÎêòÏóàÏäµÎãàÎã§! (${result.sheetName})`, 'success');
                        }
                    }
                } catch (error) {
                    console.warn('ÏûêÎèô Ïó∞Í≤∞ ÌôïÏù∏ Ïã§Ìå®:', error.message);
                    showStatus('‚ö†Ô∏è ÏõπÏï± Ïó∞Í≤∞ÏùÑ ÌôïÏù∏ÌïòÎ†§Î©¥ "Ïó∞Í≤∞ ÌÖåÏä§Ìä∏" Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏÑ∏Ïöî.', 'error');
                }
            }, 1500);
        };

        // Ïπ¥Î©îÎùº ÏãúÏûë
        async function startCamera() {
            try {
                // Í∏∞Ï°¥ Ïä§Ìä∏Î¶º Ï†ïÏßÄ
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                }

                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 2560, min: 1920 },
                        height: { ideal: 1440, min: 1080 }
                    }
                });
                
                currentStream = stream;
                video.srcObject = stream;
                
                // Ïπ¥Î©îÎùº ÌîåÎ†àÏù¥Ïä§ÌôÄÎçî Ïà®Í∏∞Í∏∞
                document.querySelector('.camera-placeholder').style.display = 'none';
                
                // UI ÏÉÅÌÉú Î≥ÄÍ≤Ω
                video.style.display = 'block';
                capturedImage.style.display = 'none';
                document.getElementById('startCameraBtn').style.display = 'none';
                document.getElementById('captureBtn').classList.remove('hidden');
                document.getElementById('retakeBtn').classList.add('hidden');
                document.getElementById('enhanceBtn').classList.add('hidden');
                
                showStatus('Ïπ¥Î©îÎùºÍ∞Ä Ï§ÄÎπÑÎêòÏóàÏäµÎãàÎã§. ÌôîÌôò Î¶¨Î≥∏Ïù¥ ÏÑ†Î™ÖÌïòÍ≤å Î≥¥Ïù¥ÎèÑÎ°ù ÏúÑÏπòÎ•º Ï°∞Ï†ïÌï¥Ï£ºÏÑ∏Ïöî.', 'success');
                
                // Ïπ¥Î©îÎùºÍ∞Ä ÏôÑÏ†ÑÌûà Î°úÎìúÎê† ÎïåÍπåÏßÄ Í∏∞Îã§Î¶º
                video.addEventListener('loadedmetadata', function() {
                    console.log(`Ïπ¥Î©îÎùº Ìï¥ÏÉÅÎèÑ: ${video.videoWidth}x${video.videoHeight}`);
                });
                
            } catch (err) {
                showStatus('Ïπ¥Î©îÎùº Ï†ëÍ∑º Í∂åÌïúÏù¥ ÌïÑÏöîÌï©ÎãàÎã§. Î∏åÎùºÏö∞Ï†Ä ÏÑ§Ï†ïÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
                console.error('Ïπ¥Î©îÎùº Ïò§Î•ò:', err);
            }
        }

        // Ï¥¨ÏòÅ
        function captureImage() {
            if (!video.srcObject) {
                showStatus('Î®ºÏ†Ä Ïπ¥Î©îÎùºÎ•º ÏãúÏûëÌï¥Ï£ºÏÑ∏Ïöî.', 'error');
                return;
            }

            // Í≥†Ìï¥ÏÉÅÎèÑ Ï∫îÎ≤ÑÏä§ ÏÑ§Ï†ï
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Ïù¥ÎØ∏ÏßÄ ÌíàÏßà Ìñ•ÏÉÅÏùÑ ÏúÑÌïú ÏÑ§Ï†ï
            ctx.imageSmoothingEnabled = false;
            ctx.drawImage(video, 0, 0);
            
            // Ï∫°Ï≤òÎêú Ïù¥ÎØ∏ÏßÄ ÌëúÏãú
            const imageData = canvas.toDataURL('image/png', 1.0);
            capturedImage.src = imageData;
            
            // UI ÏÉÅÌÉú Î≥ÄÍ≤Ω
            video.style.display = 'none';
            capturedImage.style.display = 'block';
            document.getElementById('captureBtn').classList.add('hidden');
            document.getElementById('retakeBtn').classList.remove('hidden');
            document.getElementById('enhanceBtn').classList.remove('hidden');
            
            // Ïπ¥Î©îÎùº Ïä§Ìä∏Î¶º ÏùºÏãúÏ†ïÏßÄ
            if (currentStream) {
                currentStream.getVideoTracks().forEach(track => track.enabled = false);
            }
            
            showStatus('Ï¥¨ÏòÅ ÏôÑÎ£å! ÌÖçÏä§Ìä∏ Ïù∏ÏãùÏùÑ ÏãúÏûëÌï©ÎãàÎã§...', 'success');
            
            // ÌÖçÏä§Ìä∏ Ïù∏Ïãù ÏãúÏûë
            setTimeout(() => {
                recognizeText(imageData);
            }, 800);
        }

        // Îã§Ïãú Ï¥¨ÏòÅ
        function retakePhoto() {
            // UI ÏÉÅÌÉú Î≥µÏõê
            video.style.display = 'block';
            capturedImage.style.display = 'none';
            document.getElementById('captureBtn').classList.remove('hidden');
            document.getElementById('retakeBtn').classList.add('hidden');
            document.getElementById('enhanceBtn').classList.add('hidden');
            
            // Ïπ¥Î©îÎùº Ïä§Ìä∏Î¶º Ïû¨Í∞ú
            if (currentStream) {
                currentStream.getVideoTracks().forEach(track => track.enabled = true);
            }
            
            // Í≤∞Í≥º ÏÑπÏÖò Ïà®Í∏∞Í∏∞
            document.getElementById('resultSection').classList.add('hidden');
            
            showStatus('Îã§Ïãú Ï¥¨ÏòÅÌï† Ïàò ÏûàÏäµÎãàÎã§.', 'success');
        }

        // Ìñ•ÏÉÅÎêú Ïù∏Ïãù Ïû¨ÏãúÎèÑ
        function enhanceAndRecognize() {
            if (!capturedImage.src) {
                showStatus('Î®ºÏ†Ä ÏÇ¨ÏßÑÏùÑ Ï¥¨ÏòÅÌï¥Ï£ºÏÑ∏Ïöî.', 'error');
                return;
            }
            
            showStatus('Í≥†Í∏â Ïù∏Ïãù Î™®ÎìúÎ°ú Îã§Ïãú Î∂ÑÏÑù Ï§ë...', 'processing');
            recognizeTextEnhanced(capturedImage.src);
        }

        // Í∏∞Î≥∏ ÌÖçÏä§Ìä∏ Ïù∏Ïãù (ÌôîÌôò ÏÑ∏Î°ú Î¨∏Íµ¨ Ï†ÑÏö© ÏµúÏ†ÅÌôî)
        async function recognizeText(imageData) {
            if (isProcessing) return;
            isProcessing = true;
            
            showStatus('ÌôîÌôò Î¨∏Íµ¨Î•º Ïù∏ÏãùÌïòÍ≥† ÏûàÏäµÎãàÎã§...', 'processing');
            
            try {
                // Ïù¥ÎØ∏ÏßÄ Ï†ÑÏ≤òÎ¶¨
                const img = new Image();
                img.onload = async function() {
                    const tempCanvas = document.createElement('canvas');
                    const tempCtx = tempCanvas.getContext('2d');
                    tempCanvas.width = img.width;
                    tempCanvas.height = img.height;
                    tempCtx.drawImage(img, 0, 0);
                    
                    // ÌôîÌôò Ï†ÑÏö© Ïù¥ÎØ∏ÏßÄ Ï†ÑÏ≤òÎ¶¨
                    const processedImageData = preprocessForWreath(tempCanvas, tempCtx);
                    
                    // Tesseract ÌïúÍ∏Ä/ÌïúÏûê ÏµúÏ†ÅÌôî ÏÑ§Ï†ï
                    const { data: { text } } = await Tesseract.recognize(
                        processedImageData,
                        'kor+chi_sim+chi_tra+eng',
                        {
                            logger: m => {
                                if (m.status === 'recognizing text') {
                                    showStatus(`ÌôîÌôò Î¨∏Íµ¨ Ïù∏Ïãù Ï§ë... ${Math.round(m.progress * 100)}%`, 'processing');
                                }
                            },
                            // ÌôîÌôò Î¶¨Î≥∏ Ï†ÑÏö© OCR ÏÑ§Ï†ï Í∞ïÌôî
                            tessedit_pageseg_mode: Tesseract.PSM.SINGLE_BLOCK_VERT_TEXT,
                            tessedit_ocr_engine_mode: Tesseract.OEM.LSTM_ONLY,
                            tessedit_char_whitelist: '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz„Ñ±-„Öé„Öè-„Ö£Í∞Ä-Ìû£‰∏Ä-ÈæØ .,!?()[]{}":;-_/\\„àúÊ†™Âºè‰ºöÏÇ¨Ï£ºÏãùÌöåÁ§æÎìúÎ¶ºÏò¨Î¶ºÏÇºÍ∞ÄÏï†ÎèÑÏ°∞ÏùòÏ∂ïÌïòÍ≥†Ïù∏Î™ÖÎ≥µÏòÅÎ©¥ÏïàÏãù',
                            preserve_interword_spaces: '1',
                            textord_tabfind_vertical_text: '1',
                            textord_heavy_nr: '1'
                        }
                    );

                    processWreathText(text);
                    showStatus('ÌôîÌôò Î¨∏Íµ¨ Ïù∏ÏãùÏù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§! Í≤∞Í≥ºÎ•º ÌôïÏù∏ÌïòÍ≥† ÏàòÏ†ïÌï¥Ï£ºÏÑ∏Ïöî.', 'success');
                    isProcessing = false;
                };
                img.src = imageData;
                
            } catch (error) {
                showStatus('ÌôîÌôò Î¨∏Íµ¨ Ïù∏ÏãùÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. "Ïù∏Ïãù Ìñ•ÏÉÅ" Î≤ÑÌäºÏùÑ ÏãúÎèÑÌï¥Î≥¥ÏÑ∏Ïöî.', 'error');
                console.error('OCR Ïò§Î•ò:', error);
                isProcessing = false;
            }
        }

        // Ìñ•ÏÉÅÎêú ÌÖçÏä§Ìä∏ Ïù∏Ïãù
        async function recognizeTextEnhanced(imageData) {
            if (isProcessing) return;
            isProcessing = true;
            
            try {
                const img = new Image();
                img.onload = async function() {
                    const tempCanvas = document.createElement('canvas');
                    const tempCtx = tempCanvas.getContext('2d');
                    tempCanvas.width = img.width;
                    tempCanvas.height = img.height;
                    tempCtx.drawImage(img, 0, 0);
                    
                    // Îçî Í∞ïÌôîÎêú Ïù¥ÎØ∏ÏßÄ Ï†ÑÏ≤òÎ¶¨
                    const processedImageData = preprocessForWreathEnhanced(tempCanvas, tempCtx);
                    
                    // Îã§Ï§ë OCR ÏãúÎèÑÎ°ú Ï†ïÌôïÎèÑ Ìñ•ÏÉÅ
                    const recognitionPromises = [
                        // ÏÑ∏Î°ú ÌÖçÏä§Ìä∏ Î™®Îìú
                        Tesseract.recognize(processedImageData, 'kor+chi_sim+chi_tra+eng', {
                            tessedit_pageseg_mode: Tesseract.PSM.SINGLE_BLOCK_VERT_TEXT,
                            tessedit_ocr_engine_mode: Tesseract.OEM.LSTM_ONLY,
                            logger: m => {
                                if (m.status === 'recognizing text') {
                                    showStatus(`Í≥†Í∏â Ïù∏Ïãù Î™®Îìú (ÏÑ∏Î°ú) ${Math.round(m.progress * 100)}%`, 'processing');
                                }
                            }
                        }),
                        // Îã®Ïùº Ïª¨Îüº Î™®Îìú
                        Tesseract.recognize(processedImageData, 'kor+chi_sim+chi_tra+eng', {
                            tessedit_pageseg_mode: Tesseract.PSM.SINGLE_COLUMN,
                            tessedit_ocr_engine_mode: Tesseract.OEM.LSTM_ONLY,
                            logger: m => {
                                if (m.status === 'recognizing text') {
                                    showStatus(`Í≥†Í∏â Ïù∏Ïãù Î™®Îìú (Ïª¨Îüº) ${Math.round(m.progress * 100)}%`, 'processing');
                                }
                            }
                        })
                    ];

                    const results = await Promise.all(recognitionPromises);
                    
                    // Í∞ÄÏû• Í∏¥ Í≤∞Í≥º ÏÑ†ÌÉù (Î≥¥ÌÜµ Îçî Ï†ïÌôïÌï®)
                    const bestResult = results.reduce((best, current) => 
                        current.data.text.length > best.data.text.length ? current : best
                    );

                    processWreathText(bestResult.data.text);
                    showStatus('‚ú® Í≥†Í∏â Ïù∏Ïãù Î™®Îìú ÏôÑÎ£å! Í≤∞Í≥ºÎ•º ÌôïÏù∏ÌïòÍ≥† ÌïÑÏöîÏãú ÏàòÏ†ïÌï¥Ï£ºÏÑ∏Ïöî.', 'success');
                    isProcessing = false;
                };
                img.src = imageData;
                
            } catch (error) {
                showStatus('Í≥†Í∏â Ïù∏Ïãù Î™®ÎìúÏóêÏÑúÎèÑ Ïã§Ìå®ÌñàÏäµÎãàÎã§. Ï°∞Î™ÖÏùÑ Î∞ùÍ≤å ÌïòÍ≥† Îã§Ïãú Ï¥¨ÏòÅÌï¥Î≥¥ÏÑ∏Ïöî.', 'error');
                console.error('Í≥†Í∏â OCR Ïò§Î•ò:', error);
                isProcessing = false;
            }
        }

        // ÌôîÌôò Ï†ÑÏö© Ïù¥ÎØ∏ÏßÄ Ï†ÑÏ≤òÎ¶¨ (Í∞ïÌôî Î≤ÑÏ†Ñ)
        function preprocessForWreath(canvas, ctx) {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            // ÌôîÌôò Î¶¨Î≥∏ ÌÖçÏä§Ìä∏ Í∞ïÏ°∞Î•º ÏúÑÌïú Ï†ÑÏ≤òÎ¶¨ Í∞ïÌôî
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                
                // ÌöåÏÉâÏ°∞ Î≥ÄÌôò
                const gray = r * 0.299 + g * 0.587 + b * 0.114;
                
                // Îçî Í∞ïÌïú ÎåÄÎπÑ Ï†ÅÏö©
                let enhanced;
                if (gray < 100) {
                    // Ïñ¥ÎëêÏö¥ Î∂ÄÎ∂Ñ(ÌÖçÏä§Ìä∏) Îçî Ïñ¥Îë°Í≤å
                    enhanced = Math.max(0, gray * 0.2);
                } else if (gray > 180) {
                    // Î∞ùÏùÄ Î∂ÄÎ∂Ñ(Î∞∞Í≤Ω) Îçî Î∞ùÍ≤å  
                    enhanced = 255;
                } else {
                    // Ï§ëÍ∞ÑÌÜ§ Ï≤òÎ¶¨
                    enhanced = gray < 140 ? gray * 0.4 : Math.min(255, gray * 1.5);
                }
                
                data[i] = enhanced;     // Red
                data[i + 1] = enhanced; // Green
                data[i + 2] = enhanced; // Blue
            }
            
            ctx.putImageData(imageData, 0, 0);
            return canvas.toDataURL('image/png', 1.0);
        }

        // Ìñ•ÏÉÅÎêú Ïù¥ÎØ∏ÏßÄ Ï†ÑÏ≤òÎ¶¨
        function preprocessForWreathEnhanced(canvas, ctx) {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            // 1Îã®Í≥Ñ: ÎÖ∏Ïù¥Ï¶à Ï†úÍ±∞Î•º ÏúÑÌïú ÌèâÍ∑† ÌïÑÌÑ∞
            const filteredData = new Uint8ClampedArray(data);
            const width = canvas.width;
            const height = canvas.height;
            
            for (let y = 1; y < height - 1; y++) {
                for (let x = 1; x < width - 1; x++) {
                    const idx = (y * width + x) * 4;
                    
                    // 3x3 Ïª§ÎÑê ÌèâÍ∑†
                    let rSum = 0, gSum = 0, bSum = 0;
                    for (let dy = -1; dy <= 1; dy++) {
                        for (let dx = -1; dx <= 1; dx++) {
                            const nIdx = ((y + dy) * width + (x + dx)) * 4;
                            rSum += data[nIdx];
                            gSum += data[nIdx + 1];
                            bSum += data[nIdx + 2];
                        }
                    }
                    
                    filteredData[idx] = rSum / 9;
                    filteredData[idx + 1] = gSum / 9;
                    filteredData[idx + 2] = bSum / 9;
                }
            }
            
            // 2Îã®Í≥Ñ: Í∞ïÌôîÎêú ÎåÄÎπÑ Ï†ÅÏö©
            for (let i = 0; i < filteredData.length; i += 4) {
                const r = filteredData[i];
                const g = filteredData[i + 1];
                const b = filteredData[i + 2];
                
                const gray = r * 0.299 + g * 0.587 + b * 0.114;
                
                // Ïù¥ÏßÑÌôîÏóê Í∞ÄÍπåÏö¥ Í∞ïÌïú ÎåÄÎπÑ
                const enhanced = gray < 120 ? 0 : 255;
                
                filteredData[i] = enhanced;
                filteredData[i + 1] = enhanced;
                filteredData[i + 2] = enhanced;
            }
            
            const enhancedImageData = new ImageData(filteredData, width, height);
            ctx.putImageData(enhancedImageData, 0, 0);
            return canvas.toDataURL('image/png', 1.0);
        }

        // ÌôîÌôò ÌÖçÏä§Ìä∏ Ï≤òÎ¶¨ (Ï¢å/Ïö∞ Î¶¨Î≥∏ Íµ¨Î∂Ñ) - Í∞ïÌôî Î≤ÑÏ†Ñ
        function processWreathText(text) {
            console.log('ÏõêÎ≥∏ ÌÖçÏä§Ìä∏:', text);
            
            document.getElementById('recognizedText').value = text;
            
            // ÌÖçÏä§Ìä∏ Ï†ïÎ¶¨
            const cleanedText = text
                .replace(/[^\w\s„Ñ±-„Öé„Öè-„Ö£Í∞Ä-Ìû£‰∏Ä-ÈæØ„àúÊ†™Âºè‰ºöÏÇ¨().,!?\-_]/g, ' ')
                .replace(/\s+/g, ' ')
                .trim();
            
            // ÌÖçÏä§Ìä∏Î•º Ï§ÑÎ≥ÑÎ°ú Î∂ÑÎ¶¨
            const lines = text.split(/[\n\r]+/)
                .filter(line => line.trim() !== '')
                .map(line => line.trim()
                    .replace(/[^\w\s„Ñ±-„Öé„Öè-„Ö£Í∞Ä-Ìû£‰∏Ä-ÈæØ„àúÊ†™Âºè‰ºöÏÇ¨().,!?\-_]/g, ' ')
                    .replace(/\s+/g, ' ')
                    .trim()
                )
                .filter(line => line.length > 0);
            
            console.log('Ï†ïÏ†úÎêú ÎùºÏù∏Îì§:', lines);
            
            // Ï¢åÏ∏°/Ïö∞Ï∏° Î¶¨Î≥∏ Íµ¨Î∂Ñ Î°úÏßÅ Í∞ïÌôî
            let leftRibbon = '';
            let rightRibbon = '';
            
            // ÌôîÌôò ÌÇ§ÏõåÎìú ÌôïÏû•
            const leftKeywords = [
                'Ï∂ïÌïò', 'ÏÇºÍ∞Ä', 'Í≥†Ïù∏', 'Î™ÖÎ≥µ', 'Ï°∞Ïùò', 'Ïï†ÎèÑ', 'Ï∂îÎ™®', 'ÏòÅÎ©¥', 'ÏïàÏãù',
                'Ï∂ï', 'Ï°∞', 'ÂìÄÊÇº', 'ËøΩÊÖï', 'ÂÜ•Á¶è', 'ÂÆâÊÅØ', 'Ê∞∏Áú†', 'ÊïÖ‰∫∫',
                'Ï∂ïÎ≥µ', 'Í∏∞Ïõê', 'Í∏∞ÎÖê', 'Í≤ΩÏ∂ï', 'Í∞úÏóÖ', 'Í∞úÏ†ê', 'Ï∞ΩÎ¶Ω'
            ];
            const rightKeywords = [
                'ÎìúÎ¶º', 'Ïò¨Î¶º', 'ÏùºÎèô', 'ÌöåÏÇ¨', 'Í∑∏Î£π', 'ÎåÄÌëú', 'ÏÇ¨Ïû•', '„àú', 'Ï£ºÏãùÌöåÏÇ¨',
                'Ê†™Âºè‰ºöÁ§æ', '‰ª£Ë°®', 'Á§æÈï∑', 'ÏûÑÏßÅÏõê', 'ÏßÅÏõê', 'Í∞ÄÏ°±', 'ÏπúÍµ¨', 'ÎèôÎ£å',
                'ÏÉÅ', 'Î∞∞ÏÉÅ', 'Êï¨‰∏ä', 'Êãú‰∏ä', 'Ë¨πÂºî'
            ];
            
            const leftLines = [];
            const rightLines = [];
            const neutralLines = [];
            
            for (let line of lines) {
                if (line.length < 2) continue;
                
                const hasLeftKeyword = leftKeywords.some(keyword => line.includes(keyword));
                const hasRightKeyword = rightKeywords.some(keyword => line.includes(keyword));
                
                if (hasLeftKeyword && !hasRightKeyword) {
                    leftLines.push(line);
                } else if (hasRightKeyword && !hasLeftKeyword) {
                    rightLines.push(line);
                } else {
                    neutralLines.push(line);
                }
            }
            
            // Ï§ëÏÑ± ÎùºÏù∏Îì§ÏùÑ Í∏∏Ïù¥ Í∏∞Ï§ÄÏúºÎ°ú Î∞∞Î∂Ñ
            for (let line of neutralLines) {
                if (leftLines.join(' ').length <= rightLines.join(' ').length) {
                    leftLines.push(line);
                } else {
                    rightLines.push(line);
                }
            }
            
            leftRibbon = leftLines.join(' ');
            rightRibbon = rightLines.join(' ');
            
            // ÎßåÏïΩ ÌïúÏ™ΩÏù¥ ÎπÑÏñ¥ÏûàÎã§Î©¥ Ï†ÑÏ≤¥ ÌÖçÏä§Ìä∏Î•º Î∞òÎ∞ò ÎÇòÎàÑÍ∏∞
            if (!leftRibbon && rightRibbon) {
                const words = rightRibbon.split(' ');
                const mid = Math.ceil(words.length / 2);
                leftRibbon = words.slice(0, mid).join(' ');
                rightRibbon = words.slice(mid).join(' ');
            } else if (leftRibbon && !rightRibbon) {
                const words = leftRibbon.split(' ');
                const mid = Math.ceil(words.length / 2);
                rightRibbon = words.slice(mid).join(' ');
                leftRibbon = words.slice(0, mid).join(' ');
            }
            
            document.getElementById('leftRibbon').value = leftRibbon;
            document.getElementById('rightRibbon').value = rightRibbon;
            
            document.getElementById('resultSection').classList.remove('hidden');
        }

        // Ïó∞Í≤∞ ÌÖåÏä§Ìä∏ Ìï®Ïàò (Í∞ïÌôîÎêú Ïò§Î•ò Ï≤òÎ¶¨)
        async function testConnection() {
            showStatus('ÌôîÌôò ÏõπÏï± Ïó∞Í≤∞ ÌÖåÏä§Ìä∏ Ï§ë...', 'processing');
            
            try {
                console.log('ÌÖåÏä§Ìä∏ URL:', WEBAPP_URL);
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10Ï¥à ÌÉÄÏûÑÏïÑÏõÉ
                
                const response = await fetch(WEBAPP_URL + '?test=true&_=' + Date.now(), {
                    method: 'GET',
                    mode: 'cors',
                    cache: 'no-cache',
                    signal: controller.signal,
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                clearTimeout(timeoutId);
                
                console.log('ÏùëÎãµ ÏÉÅÌÉú:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('ÌÖåÏä§Ìä∏ Í≤∞Í≥º:', result);
                
                if (result.success) {
                    showStatus(`‚úÖ Ïó∞Í≤∞ ÏÑ±Í≥µ! ÏãúÌä∏: ${result.sheetName || 'N/A'}, ÌôîÌôò Îç∞Ïù¥ÌÑ∞: ${result.totalRows || 0}Í∞ú`, 'success');
                } else {
                    showStatus(`‚ùå ÏÑúÎ≤Ñ ÏùëÎãµ Ïò§Î•ò: ${result.message}`, 'error');
                }
                
            } catch (error) {
                console.error('Ïó∞Í≤∞ ÌÖåÏä§Ìä∏ Ïò§Î•ò:', error);
                
                if (error.name === 'AbortError') {
                    showStatus('‚ùå Ïó∞Í≤∞ ÏãúÍ∞Ñ Ï¥àÍ≥º: ÏõπÏï± URLÏùÑ ÌôïÏù∏ÌïòÍ±∞ÎÇò ÏÉàÎ°ú Î∞∞Ìè¨Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
                } else if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                    showStatus('‚ùå ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•ò: Ïù∏ÌÑ∞ÎÑ∑ Ïó∞Í≤∞Í≥º ÏõπÏï± URLÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
                } else if (error.message.includes('CORS')) {
                    showStatus('‚ùå CORS Ïò§Î•ò: Apps ScriptÎ•º ÏÉàÎ°ú Î∞∞Ìè¨Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
                } else {
                    showStatus(`‚ùå Ïó∞Í≤∞ Ïã§Ìå®: ${error.message}`, 'error');
                }
            }
        }

        // Ïä§ÌîÑÎ†àÎìúÏãúÌä∏ Ï†ÄÏû• (Í∞ïÌôîÎêú Ïò§Î•ò Ï≤òÎ¶¨ Î∞è Ïû¨ÏãúÎèÑ)
        async function saveToSheets(retryCount = 0) {
            const data = {
                timestamp: new Date().toLocaleString('ko-KR', {
                    timeZone: 'Asia/Seoul',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                }),
                leftRibbon: document.getElementById('leftRibbon').value.trim(),
                rightRibbon: document.getElementById('rightRibbon').value.trim(),
                recognizedText: document.getElementById('recognizedText').value.trim()
            };
            
            // Îç∞Ïù¥ÌÑ∞ Í≤ÄÏ¶ù
            if (!data.leftRibbon && !data.rightRibbon && !data.recognizedText) {
                showStatus('Ï†ÄÏû•Ìï† ÌôîÌôò Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§. Î®ºÏ†Ä ÌÖçÏä§Ìä∏Î•º Ïù∏ÏãùÌï¥Ï£ºÏÑ∏Ïöî.', 'error');
                return;
            }
            
            // Î°úÏª¨ Ï†ÄÏû•
            savedData.unshift(data); // ÏµúÏã† Îç∞Ïù¥ÌÑ∞Î•º ÏïûÏóê Ï∂îÍ∞Ä
            if (savedData.length > 50) { // ÏµúÎåÄ 50Í∞úÎßå Î≥¥Í¥Ä
                savedData = savedData.slice(0, 50);
            }
            localStorage.setItem('wreathData', JSON.stringify(savedData));
            updateDataList();
            
            try {
                showStatus('ÌôîÌôò Ï†ïÎ≥¥Î•º Ïä§ÌîÑÎ†àÎìúÏãúÌä∏Ïóê Ï†ÄÏû• Ï§ë...', 'processing');
                
                console.log('ÌôîÌôò Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• ÏãúÎèÑ:', {
                    url: WEBAPP_URL,
                    data: data,
                    attempt: retryCount + 1
                });
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000); // 15Ï¥à ÌÉÄÏûÑÏïÑÏõÉ
                
                const response = await fetch(WEBAPP_URL + '?_=' + Date.now(), {
                    method: 'POST',
                    mode: 'cors',
                    cache: 'no-cache',
                    signal: controller.signal,
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                clearTimeout(timeoutId);
                
                console.log('Ï†ÄÏû• ÏùëÎãµ ÏÉÅÌÉú:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('Ï†ÄÏû• Í≤∞Í≥º:', result);
                
                if (result.success) {
                    showStatus(`‚úÖ ÌôîÌôò Ï†ïÎ≥¥ Ï†ÄÏû• ÏôÑÎ£å! (Ìñâ: ${result.rowNumber || 'N/A'})`, 'success');
                    
                    // Ìèº Ï¥àÍ∏∞Ìôî
                    document.getElementById('leftRibbon').value = '';
                    document.getElementById('rightRibbon').value = '';
                    document.getElementById('recognizedText').value = '';
                    document.getElementById('resultSection').classList.add('hidden');
                    
                    // Îã§Ïãú Ï¥¨ÏòÅ Ï§ÄÎπÑ
                    setTimeout(() => {
                        showStatus('ÏÉàÎ°úÏö¥ ÌôîÌôòÏùÑ Ï¥¨ÏòÅÌï† Ï§ÄÎπÑÍ∞Ä ÎêòÏóàÏäµÎãàÎã§.', 'success');
                    }, 2000);
                    
                } else {
                    throw new Error(result.message || result.error || 'Ï†ÄÏû• Ïã§Ìå®');
                }
                
            } catch (error) {
                console.error('Ï†ÄÏû• Ïò§Î•ò:', error);
                
                // Ïû¨ÏãúÎèÑ Î°úÏßÅ (ÏµúÎåÄ 2Ìöå)
                if (retryCount < 2 && (
                    error.name === 'AbortError' || 
                    error.name === 'TypeError' ||
                    error.message.includes('network')
                )) {
                    console.log(`Ïû¨ÏãúÎèÑ Ï§ë... (${retryCount + 1}/2)`);
                    showStatus(`Ï†ÄÏû• Ïû¨ÏãúÎèÑ Ï§ë... (${retryCount + 2}/3)`, 'processing');
                    
                    setTimeout(() => {
                        saveToSheets(retryCount + 1);
                    }, 2000);
                    return;
                }
                
                // Ïò§Î•ò Î©îÏãúÏßÄ Í∞úÏÑ†
                if (error.name === 'AbortError') {
                    showStatus('‚ùå Ï†ÄÏû• ÏãúÍ∞Ñ Ï¥àÍ≥º: ÎÑ§Ìä∏ÏõåÌÅ¨ ÏÉÅÌÉúÎ•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
                } else if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                    showStatus('‚ùå ÎÑ§Ìä∏ÏõåÌÅ¨ Ïó∞Í≤∞ Ïã§Ìå®: Ïù∏ÌÑ∞ÎÑ∑ Ïó∞Í≤∞Í≥º ÏõπÏï± URLÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
                } else if (error.message.includes('CORS')) {
                    showStatus('‚ùå CORS Ïò§Î•ò: Apps ScriptÎ•º ÏÉàÎ°ú Î∞∞Ìè¨Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
                } else {
                    showStatus(`‚ùå Ï†ÄÏû• Ïã§Ìå®: ${error.message}`, 'error');
                }
                
                // Î°úÏª¨ÏóêÎäî Ï†ÄÏû•ÎêòÏóàÏùåÏùÑ ÏïåÎ¶º
                setTimeout(() => {
                    showStatus('üíæ Î°úÏª¨ Ï†ÄÏû•ÏùÄ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§. ÎÑ§Ìä∏ÏõåÌÅ¨ ÌôïÏù∏ ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.', 'success');
                }, 3000);
            }
        }

        // ÏÉÅÌÉú ÌëúÏãú (Ìñ•ÏÉÅÎêú Î≤ÑÏ†Ñ)
        function showStatus(message, type) {
            const statusEl = document.getElementById('status');
            statusEl.className = `status ${type}`;
            statusEl.classList.remove('hidden');
            
            if (type === 'processing') {
                statusEl.innerHTML = '<span class="loading"></span>' + message;
            } else {
                statusEl.textContent = message;
            }
            
            // ÏÑ±Í≥µ/Ïò§Î•ò Î©îÏãúÏßÄÎäî 5Ï¥à ÌõÑ ÏûêÎèôÏúºÎ°ú Ïà®ÍπÄ
            if (type === 'success' || type === 'error') {
                setTimeout(() => {
                    if (statusEl.textContent === message) {
                        statusEl.classList.add('hidden');
                    }
                }, 5000);
            }
        }

        // Ï†ÄÏû•Îêú Îç∞Ïù¥ÌÑ∞ Î∂àÎü¨Ïò§Í∏∞
        function loadSavedData() {
            const saved = localStorage.getItem('wreathData');
            if (saved) {
                try {
                    savedData = JSON.parse(saved);
                    updateDataList();
                } catch (error) {
                    console.error('Î°úÏª¨ Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ïò§Î•ò:', error);
                    savedData = [];
                }
            }
        }

        // Îç∞Ïù¥ÌÑ∞ Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏ (ÌôîÌôò Ï†ÑÏö©)
        function updateDataList() {
            const savedItems = document.getElementById('savedItems');
            savedItems.innerHTML = '';
            
            if (savedData.length === 0) {
                savedItems.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 25px; background: #f8f9fa; border-radius: 8px;">Ï†ÄÏû•Îêú ÌôîÌôò Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.<br><small>Ï¥¨ÏòÅ ÌõÑ Ï†ÄÏû•ÌïòÎ©¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§.</small></p>';
                return;
            }
            
            // ÏµúÏã† 5Í∞úÎßå ÌëúÏãú
            const recentData = savedData.slice(0, 5);
            
            recentData.forEach((item, index) => {
                const itemEl = document.createElement('div');
                itemEl.className = 'data-item';
                itemEl.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <strong>üå∏ ÌôîÌôò Ï†ïÎ≥¥ #${index + 1}</strong>
                        <small style="color: #6c757d;">${item.timestamp}</small>
                    </div>
                    <div style="margin-top: 10px;">
                        <div style="background: #e3f2fd; padding: 8px; border-radius: 6px; margin-bottom: 6px; border-left: 3px solid #2196f3;">
                            <strong>Ï¢åÏ∏°:</strong> ${item.leftRibbon || '(ÏóÜÏùå)'}
                        </div>
                        <div style="background: #f3e5f5; padding: 8px; border-radius: 6px; border-left: 3px solid #9c27b0;">
                            <strong>Ïö∞Ï∏°:</strong> ${item.rightRibbon || '(ÏóÜÏùå)'}
                        </div>
                    </div>
                `;
                savedItems.appendChild(itemEl);
            });
            
            if (savedData.length > 5) {
                const moreInfo = document.createElement('p');
                moreInfo.style.cssText = 'text-align: center; color: #6c757d; margin-top: 10px; font-size: 12px;';
                moreInfo.textContent = `Ïô∏ ${savedData.length - 5}Í∞úÏùò Îç∞Ïù¥ÌÑ∞Í∞Ä Îçî ÏûàÏäµÎãàÎã§.`;
                savedItems.appendChild(moreInfo);
            }
        }

        // ÌéòÏù¥ÏßÄ Ïñ∏Î°úÎìú Ïãú Ïπ¥Î©îÎùº Ï†ïÎ¶¨
        window.addEventListener('beforeunload', function() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }
        });

        // ÌéòÏù¥ÏßÄ visibility Î≥ÄÍ≤Ω Ïãú Ïπ¥Î©îÎùº Í¥ÄÎ¶¨
        document.addEventListener('visibilitychange', function() {
            if (currentStream) {
                if (document.hidden) {
                    // ÌéòÏù¥ÏßÄÍ∞Ä Ïà®Í≤®ÏßÄÎ©¥ Ïπ¥Î©îÎùº ÏùºÏãúÏ†ïÏßÄ
                    currentStream.getVideoTracks().forEach(track => track.enabled = false);
                } else {
                    // ÌéòÏù¥ÏßÄÍ∞Ä Îã§Ïãú Î≥¥Ïù¥Î©¥ Ïπ¥Î©îÎùº Ïû¨Í∞ú
                    currentStream.getVideoTracks().forEach(track => track.enabled = true);
                }
            }
        });
    </script>
</body>
</html>
