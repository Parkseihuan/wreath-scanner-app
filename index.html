<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í™”í™˜ ë¬¸êµ¬ ì¸ì‹ ì•±</title>
    <meta name="description" content="í™”í™˜ ë¬¸êµ¬ë¥¼ ìë™ìœ¼ë¡œ ì¸ì‹í•˜ì—¬ êµ¬ê¸€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì— ì €ì¥">
    
    <!-- 
    ==========================================
    ğŸ› ï¸ ê´€ë¦¬ì ì„¤ì • ê°€ì´ë“œ 
    ==========================================
    
    ğŸ“‹ 1ë‹¨ê³„: Google ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ìƒì„±
    - ìƒˆ êµ¬ê¸€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ìƒì„±
    - íŒŒì¼ëª…: "í™”í™˜ ë¬¸êµ¬ ê¸°ë¡"
    
    ğŸ“‹ 2ë‹¨ê³„: Apps Script ì„¤ì •
    - ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì—ì„œ "í™•ì¥ í”„ë¡œê·¸ë¨" > "Apps Script" í´ë¦­
    - ê¸°ì¡´ ì½”ë“œ ëª¨ë‘ ì‚­ì œ
    - ì œê³µëœ code.gs íŒŒì¼ ë‚´ìš© ì „ì²´ ë³µì‚¬ & ë¶™ì—¬ë„£ê¸°
    - Ctrl+Së¡œ ì €ì¥
    
    ğŸ“‹ 3ë‹¨ê³„: ì›¹ì•± ë°°í¬
    - "ë°°í¬" > "ìƒˆ ë°°í¬" í´ë¦­
    - ìœ í˜•: "ì›¹ ì•±" ì„ íƒ
    - ì„¤ëª…: "í™”í™˜ ë¬¸êµ¬ ì¸ì‹ ì•±"
    - ì‹¤í–‰ ê¶Œí•œ: "ë‚˜"
    - ì•¡ì„¸ìŠ¤ ê¶Œí•œ: "ëª¨ë“  ì‚¬ìš©ì" â­ ì¤‘ìš”!
    - "ë°°í¬" í´ë¦­
    - ì›¹ì•± URL ë³µì‚¬ (ì˜ˆ: https://script.google.com/macros/s/AKfycbx.../exec)
    
    ğŸ“‹ 4ë‹¨ê³„: ì´ íŒŒì¼ ìˆ˜ì •
    - ì•„ë˜ JavaScript ì½”ë“œì—ì„œ WEBAPP_URL ë³€ìˆ˜ë¥¼ 
      ì‹¤ì œ ì›¹ì•± URLë¡œ ë³€ê²½í•˜ì„¸ìš”!
    
    ğŸ”§ ë¬¸ì œ í•´ê²°:
    - "ì—°ê²° í…ŒìŠ¤íŠ¸" ë²„íŠ¼ìœ¼ë¡œ ì„¤ì • í™•ì¸ ê°€ëŠ¥
    - ë¸Œë¼ìš°ì € ê°œë°œì ë„êµ¬(F12) > Consoleì—ì„œ ì˜¤ë¥˜ í™•ì¸
    - Apps Script > ì‹¤í–‰ ë‚´ì—­ì—ì„œ ë¡œê·¸ í™•ì¸
    
    ==========================================
    -->
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="í™”í™˜ ë¬¸êµ¬ ì¸ì‹">
    
    <!-- íŒŒë¹„ì½˜ -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸŒ¸</text></svg>">
    
    <!-- Tesseract.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.1.1/tesseract.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 8px;
            margin: 0;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .container {
            max-width: 420px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff6b6b, #ffd93d);
            color: white;
            padding: 16px;
            text-align: center;
        }

        .header h1 {
            font-size: 22px;
            margin-bottom: 6px;
            font-weight: 700;
        }

        .header p {
            font-size: 13px;
            opacity: 0.9;
        }

        .content {
            padding: 16px;
        }

        .camera-container {
            position: relative;
            width: 100%;
            margin: 0 auto 20px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 6px 20px rgba(0,0,0,0.12);
            background: #f8f9fa;
            min-height: 280px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #video {
            width: 100%;
            height: auto;
            display: block;
            max-height: 400px;
            object-fit: cover;
        }

        #capturedImage {
            width: 100%;
            height: auto;
            display: none;
            max-height: 400px;
            object-fit: contain;
        }

        #canvas {
            display: none;
        }

        .camera-placeholder {
            text-align: center;
            color: #6c757d;
            padding: 40px 20px;
        }

        .camera-placeholder .icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        button {
            padding: 14px 24px;
            border: none;
            border-radius: 28px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            position: relative;
            overflow: hidden;
            min-height: 50px;
        }

        button:active {
            transform: scale(0.96);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover {
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        .btn-success:hover {
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
        }

        .btn-secondary:hover {
            box-shadow: 0 6px 20px rgba(108, 117, 125, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107, #fd7e14);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
        }

        .btn-warning:hover {
            box-shadow: 0 6px 20px rgba(255, 193, 7, 0.4);
        }

        /* ê³ ì • í•˜ë‹¨ ì»¨íŠ¸ë¡¤ */
        .fixed-controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(255,255,255,0.98), rgba(255,255,255,0.95));
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 16px;
            border-top: 1px solid rgba(0,0,0,0.1);
            z-index: 1000;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
        }

        .fixed-controls .controls {
            max-width: 420px;
            margin: 0 auto;
            margin-bottom: 0;
        }

        /* í•˜ë‹¨ ì»¨íŠ¸ë¡¤ì„ ìœ„í•œ ì—¬ë°± */
        .content-with-fixed-controls {
            margin-bottom: 100px;
        }

        .status {
            text-align: center;
            padding: 12px;
            margin: 12px 0;
            border-radius: 10px;
            font-weight: 500;
            font-size: 14px;
        }

        .status.processing {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .result-section {
            background: #f8f9fa;
            padding: 18px;
            border-radius: 12px;
            margin: 18px 0;
            border: 1px solid #e9ecef;
        }

        .result-section h3 {
            color: #495057;
            margin-bottom: 16px;
            text-align: center;
            font-size: 17px;
        }

        .form-group {
            margin-bottom: 14px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #495057;
            font-size: 14px;
        }

        input, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 14px;
            font-family: inherit;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            transition: border-color 0.3s ease;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea {
            height: 70px;
            resize: vertical;
            min-height: 50px;
        }

        .data-list {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-top: 18px;
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
        }

        .data-list h3 {
            color: #495057;
            margin-bottom: 12px;
            text-align: center;
            font-size: 16px;
        }

        .data-item {
            background: #f8f9fa;
            padding: 12px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            font-size: 13px;
        }

        .connection-test {
            text-align: center;
            padding: 16px;
            margin-top: 12px;
        }

        .connection-test button {
            width: 100%;
            max-width: 280px;
        }

        .loading {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        .footer {
            text-align: center;
            padding: 16px;
            color: #6c757d;
            font-size: 12px;
            border-top: 1px solid #e9ecef;
        }

        /* OCR í’ˆì§ˆ í–¥ìƒ íŒ */
        .ocr-tips {
            background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
            padding: 16px;
            border-radius: 12px;
            margin: 16px 0;
            border: 1px solid #bbdefb;
        }

        .ocr-tips h4 {
            color: #1976d2;
            margin-bottom: 8px;
            font-size: 15px;
        }

        .ocr-tips ul {
            margin: 0;
            padding-left: 16px;
            color: #424242;
            font-size: 13px;
            line-height: 1.4;
        }

        .ocr-tips li {
            margin-bottom: 4px;
        }

        /* ëª¨ë°”ì¼ ìµœì í™” */
        @media (max-width: 480px) {
            body {
                padding: 4px;
            }
            
            .container {
                margin: 4px;
                border-radius: 12px;
            }
            
            .header {
                padding: 14px;
            }
            
            .content {
                padding: 14px;
            }
            
            button {
                min-width: 110px;
                font-size: 14px;
                padding: 12px 20px;
                min-height: 48px;
            }
            
            .controls {
                gap: 10px;
            }

            .camera-container {
                min-height: 250px;
            }

            .fixed-controls {
                padding: 12px;
            }
        }

        /* ì´ˆì†Œí˜• í™”ë©´ */
        @media (max-width: 350px) {
            button {
                min-width: 100px;
                font-size: 13px;
                padding: 10px 16px;
                min-height: 44px;
            }
        }

        /* iOS ì‚¬íŒŒë¦¬ ìµœì í™” */
        @supports (-webkit-touch-callout: none) {
            .camera-container {
                -webkit-overflow-scrolling: touch;
            }
            
            input, textarea {
                -webkit-appearance: none;
                border-radius: 10px;
            }

            .fixed-controls {
                padding-bottom: calc(16px + env(safe-area-inset-bottom));
            }
        }

        /* ë‹¤í¬ëª¨ë“œ ëŒ€ì‘ */
        @media (prefers-color-scheme: dark) {
            .camera-placeholder {
                color: #8e9aaf;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>ğŸŒ¸ í™”í™˜ ë¬¸êµ¬ ì¸ì‹ ì•±</h1>
            <p>í™”í™˜ì„ ì´¬ì˜í•˜ì—¬ ìë™ìœ¼ë¡œ ë¬¸êµ¬ë¥¼ ì¸ì‹í•˜ê³  ê¸°ë¡í•©ë‹ˆë‹¤</p>
        </header>
        
        <main class="content content-with-fixed-controls">
            <!-- ì¹´ë©”ë¼ -->
            <section class="camera-section">
                <div class="camera-container" id="cameraContainer">
                    <div class="camera-placeholder">
                        <div class="icon">ğŸ“·</div>
                        <p>ì¹´ë©”ë¼ë¥¼ ì‹œì‘í•˜ë ¤ë©´<br>ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”</p>
                    </div>
                    <video id="video" autoplay playsinline></video>
                    <img id="capturedImage" alt="ì´¬ì˜ëœ ì´ë¯¸ì§€" />
                    <canvas id="canvas"></canvas>
                </div>

                <!-- OCR í’ˆì§ˆ í–¥ìƒ íŒ -->
                <div class="ocr-tips">
                    <h4>ğŸ“ ì¸ì‹ë¥  í–¥ìƒ íŒ</h4>
                    <ul>
                        <li>ë°ì€ ê³³ì—ì„œ ì´¬ì˜í•˜ì„¸ìš”</li>
                        <li>í™”í™˜ ë¦¬ë³¸ì´ í™”ë©´ ì¤‘ì•™ì— ì˜¤ë„ë¡ í•˜ì„¸ìš”</li>
                        <li>ì¹´ë©”ë¼ì™€ ë¦¬ë³¸ì´ ìˆ˜ì§ì´ ë˜ë„ë¡ í•˜ì„¸ìš”</li>
                        <li>ê¸€ìê°€ ì„ ëª…í•˜ê²Œ ë³´ì´ë„ë¡ ê°€ê¹Œì´ ì´¬ì˜í•˜ì„¸ìš”</li>
                        <li>ê·¸ë¦¼ìê°€ ì—†ëŠ” ê³³ì—ì„œ ì´¬ì˜í•˜ì„¸ìš”</li>
                    </ul>
                </div>
            </section>

            <!-- ì—°ê²° í…ŒìŠ¤íŠ¸ -->
            <section class="connection-test">
                <button class="btn-secondary" onclick="testConnection()">ğŸ”§ ì—°ê²° í…ŒìŠ¤íŠ¸</button>
            </section>

            <!-- ìƒíƒœ -->
            <div id="status" class="status hidden"></div>

            <!-- ê²°ê³¼ -->
            <section id="resultSection" class="result-section hidden">
                <h3>ğŸ“ ì¸ì‹ëœ í™”í™˜ ë¬¸êµ¬</h3>
                <div class="form-group">
                    <label for="leftRibbon">ì¢Œì¸¡ ë¦¬ë³¸ ë¬¸êµ¬:</label>
                    <textarea id="leftRibbon" placeholder="ì¢Œì¸¡ ë¦¬ë³¸ì—ì„œ ì¸ì‹ëœ ë¬¸êµ¬"></textarea>
                </div>
                <div class="form-group">
                    <label for="rightRibbon">ìš°ì¸¡ ë¦¬ë³¸ ë¬¸êµ¬:</label>
                    <textarea id="rightRibbon" placeholder="ìš°ì¸¡ ë¦¬ë³¸ì—ì„œ ì¸ì‹ëœ ë¬¸êµ¬"></textarea>
                </div>
                <div class="form-group">
                    <label for="recognizedText">ì „ì²´ ì¸ì‹ í…ìŠ¤íŠ¸:</label>
                    <textarea id="recognizedText" placeholder="ì¸ì‹ëœ ì „ì²´ í…ìŠ¤íŠ¸"></textarea>
                </div>
                <div class="controls">
                    <button class="btn-success" onclick="saveToSheets()">ğŸ’¾ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì— ì €ì¥</button>
                </div>
            </section>

            <!-- ì €ì¥ëœ ë°ì´í„° -->
            <section class="data-list">
                <h3>ğŸ’¾ ìµœê·¼ ì €ì¥ëœ ë°ì´í„°</h3>
                <div id="savedItems"></div>
            </section>
        </main>

        <!-- ê³ ì • í•˜ë‹¨ ì»¨íŠ¸ë¡¤ -->
        <div class="fixed-controls">
            <div class="controls">
                <button id="startCameraBtn" class="btn-primary" onclick="startCamera()">ğŸ“· ì¹´ë©”ë¼ ì‹œì‘</button>
                <button id="captureBtn" class="btn-success hidden" onclick="captureImage()">ğŸ“¸ ì´¬ì˜í•˜ê¸°</button>
                <button id="retakeBtn" class="btn-warning hidden" onclick="retakePhoto()">ğŸ”„ ë‹¤ì‹œ ì´¬ì˜</button>
                <button id="enhanceBtn" class="btn-warning hidden" onclick="enhanceAndRecognize()">âœ¨ ì¸ì‹ í–¥ìƒ</button>
            </div>
        </div>

        <footer class="footer">
            <p>ğŸŒ¸ í™”í™˜ ë¬¸êµ¬ ì¸ì‹ ì•± v2.0 - ì¸ì‹ë¥  ê°œì„  ë²„ì „</p>
        </footer>
    </div>

    <script>
        // ==========================================
        // ğŸ”§ ê´€ë¦¬ì ì„¤ì • - ì•„ë˜ URLì„ ë³€ê²½í•˜ì„¸ìš”!
        // ==========================================
        const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbynsYiZLDH2m46fsyGqhZRQv7ykrEWsDzH0xHaQ4dBJtOoR-EBzf0KAU5rCWwWUBESlCw/exec';
        
        let video = document.getElementById('video');
        let canvas = document.getElementById('canvas');
        let capturedImage = document.getElementById('capturedImage');
        let ctx = canvas.getContext('2d');
        let savedData = [];
        let currentStream = null;
        let isProcessing = false;

        // ì´ˆê¸°í™” (ìë™ ì—°ê²° í™•ì¸)
        window.onload = function() {
            loadSavedData();
            
            // ìë™ìœ¼ë¡œ ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ì¡°ìš©íˆ)
            setTimeout(async () => {
                try {
                    const response = await fetch(WEBAPP_URL, {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' },
                        mode: 'cors'
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            console.log('âœ… ì›¹ì•± ì—°ê²° í™•ì¸ë¨:', result.sheetName);
                            showStatus(`âœ… í™”í™˜ ì¸ì‹ ì•±ì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤! (${result.sheetName})`, 'success');
                        }
                    }
                } catch (error) {
                    console.warn('ìë™ ì—°ê²° í™•ì¸ ì‹¤íŒ¨:', error.message);
                    showStatus('âš ï¸ ì›¹ì•± ì—°ê²°ì„ í™•ì¸í•˜ë ¤ë©´ "ì—°ê²° í…ŒìŠ¤íŠ¸" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.', 'error');
                }
            }, 1500);
        };

        // ì¹´ë©”ë¼ ì‹œì‘
        async function startCamera() {
            try {
                // ê¸°ì¡´ ìŠ¤íŠ¸ë¦¼ ì •ì§€
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                }

                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 2560, min: 1920 },
                        height: { ideal: 1440, min: 1080 }
                    }
                });
                
                currentStream = stream;
                video.srcObject = stream;
                
                // ì¹´ë©”ë¼ í”Œë ˆì´ìŠ¤í™€ë” ìˆ¨ê¸°ê¸°
                document.querySelector('.camera-placeholder').style.display = 'none';
                
                // UI ìƒíƒœ ë³€ê²½
                video.style.display = 'block';
                capturedImage.style.display = 'none';
                document.getElementById('startCameraBtn').style.display = 'none';
                document.getElementById('captureBtn').classList.remove('hidden');
                document.getElementById('retakeBtn').classList.add('hidden');
                document.getElementById('enhanceBtn').classList.add('hidden');
                
                showStatus('ì¹´ë©”ë¼ê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤. í™”í™˜ ë¦¬ë³¸ì´ ì„ ëª…í•˜ê²Œ ë³´ì´ë„ë¡ ìœ„ì¹˜ë¥¼ ì¡°ì •í•´ì£¼ì„¸ìš”.', 'success');
                
                // ì¹´ë©”ë¼ê°€ ì™„ì „íˆ ë¡œë“œë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼
                video.addEventListener('loadedmetadata', function() {
                    console.log(`ì¹´ë©”ë¼ í•´ìƒë„: ${video.videoWidth}x${video.videoHeight}`);
                });
                
            } catch (err) {
                showStatus('ì¹´ë©”ë¼ ì ‘ê·¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');
                console.error('ì¹´ë©”ë¼ ì˜¤ë¥˜:', err);
            }
        }

        // ì´¬ì˜
        function captureImage() {
            if (!video.srcObject) {
                showStatus('ë¨¼ì € ì¹´ë©”ë¼ë¥¼ ì‹œì‘í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            // ê³ í•´ìƒë„ ìº”ë²„ìŠ¤ ì„¤ì •
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // ì´ë¯¸ì§€ í’ˆì§ˆ í–¥ìƒì„ ìœ„í•œ ì„¤ì •
            ctx.imageSmoothingEnabled = false;
            ctx.drawImage(video, 0, 0);
            
            // ìº¡ì²˜ëœ ì´ë¯¸ì§€ í‘œì‹œ
            const imageData = canvas.toDataURL('image/png', 1.0);
            capturedImage.src = imageData;
            
            // UI ìƒíƒœ ë³€ê²½
            video.style.display = 'none';
            capturedImage.style.display = 'block';
            document.getElementById('captureBtn').classList.add('hidden');
            document.getElementById('retakeBtn').classList.remove('hidden');
            document.getElementById('enhanceBtn').classList.remove('hidden');
            
            // ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ ì¼ì‹œì •ì§€
            if (currentStream) {
                currentStream.getVideoTracks().forEach(track => track.enabled = false);
            }
            
            showStatus('ì´¬ì˜ ì™„ë£Œ! í…ìŠ¤íŠ¸ ì¸ì‹ì„ ì‹œì‘í•©ë‹ˆë‹¤...', 'success');
            
            // í…ìŠ¤íŠ¸ ì¸ì‹ ì‹œì‘
            setTimeout(() => {
                recognizeText(imageData);
            }, 800);
        }

        // ë‹¤ì‹œ ì´¬ì˜
        function retakePhoto() {
            // UI ìƒíƒœ ë³µì›
            video.style.display = 'block';
            capturedImage.style.display = 'none';
            document.getElementById('captureBtn').classList.remove('hidden');
            document.getElementById('retakeBtn').classList.add('hidden');
            document.getElementById('enhanceBtn').classList.add('hidden');
            
            // ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ ì¬ê°œ
            if (currentStream) {
                currentStream.getVideoTracks().forEach(track => track.enabled = true);
            }
            
            // ê²°ê³¼ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            document.getElementById('resultSection').classList.add('hidden');
            
            showStatus('ë‹¤ì‹œ ì´¬ì˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'success');
        }

        // í–¥ìƒëœ ì¸ì‹ ì¬ì‹œë„
        function enhanceAndRecognize() {
            if (!capturedImage.src) {
                showStatus('ë¨¼ì € ì‚¬ì§„ì„ ì´¬ì˜í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            showStatus('ê³ ê¸‰ ì¸ì‹ ëª¨ë“œë¡œ ë‹¤ì‹œ ë¶„ì„ ì¤‘...', 'processing');
            recognizeTextEnhanced(capturedImage.src);
        }

        // ê¸°ë³¸ í…ìŠ¤íŠ¸ ì¸ì‹ (í™”í™˜ ì„¸ë¡œ ë¬¸êµ¬ ì „ìš© ìµœì í™”)
        async function recognizeText(imageData) {
            if (isProcessing) return;
            isProcessing = true;
            
            showStatus('í™”í™˜ ë¬¸êµ¬ë¥¼ ì¸ì‹í•˜ê³  ìˆìŠµë‹ˆë‹¤...', 'processing');
            
            try {
                // ì´ë¯¸ì§€ ì „ì²˜ë¦¬
                const img = new Image();
                img.onload = async function() {
                    const tempCanvas = document.createElement('canvas');
                    const tempCtx = tempCanvas.getContext('2d');
                    tempCanvas.width = img.width;
                    tempCanvas.height = img.height;
                    tempCtx.drawImage(img, 0, 0);
                    
                    // í™”í™˜ ì „ìš© ì´ë¯¸ì§€ ì „ì²˜ë¦¬
                    const processedImageData = preprocessForWreath(tempCanvas, tempCtx);
                    
                    // Tesseract í•œê¸€/í•œì ìµœì í™” ì„¤ì •
                    const { data: { text } } = await Tesseract.recognize(
                        processedImageData,
                        'kor+chi_sim+chi_tra+eng',
                        {
                            logger: m => {
                                if (m.status === 'recognizing text') {
                                    showStatus(`í™”í™˜ ë¬¸êµ¬ ì¸ì‹ ì¤‘... ${Math.round(m.progress * 100)}%`, 'processing');
                                }
                            },
                            // í™”í™˜ ë¦¬ë³¸ ì „ìš© OCR ì„¤ì • ê°•í™”
                            tessedit_pageseg_mode: Tesseract.PSM.SINGLE_BLOCK_VERT_TEXT,
                            tessedit_ocr_engine_mode: Tesseract.OEM.LSTM_ONLY,
                            tessedit_char_whitelist: '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyzã„±-ã…ã…-ã…£ê°€-í£ä¸€-é¾¯ .,!?()[]{}":;-_/\\ãˆœæ ªå¼ä¼šì‚¬ì£¼ì‹íšŒç¤¾ë“œë¦¼ì˜¬ë¦¼ì‚¼ê°€ì• ë„ì¡°ì˜ì¶•í•˜ê³ ì¸ëª…ë³µì˜ë©´ì•ˆì‹',
                            preserve_interword_spaces: '1',
                            textord_tabfind_vertical_text: '1',
                            textord_heavy_nr: '1'
                        }
                    );

                    processWreathText(text);
                    showStatus('í™”í™˜ ë¬¸êµ¬ ì¸ì‹ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ê²°ê³¼ë¥¼ í™•ì¸í•˜ê³  ìˆ˜ì •í•´ì£¼ì„¸ìš”.', 'success');
                    isProcessing = false;
                };
                img.src = imageData;
                
            } catch (error) {
                showStatus('í™”í™˜ ë¬¸êµ¬ ì¸ì‹ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. "ì¸ì‹ í–¥ìƒ" ë²„íŠ¼ì„ ì‹œë„í•´ë³´ì„¸ìš”.', 'error');
                console.error('OCR ì˜¤ë¥˜:', error);
                isProcessing = false;
            }
        }

        // í–¥ìƒëœ í…ìŠ¤íŠ¸ ì¸ì‹
        async function recognizeTextEnhanced(imageData) {
            if (isProcessing) return;
            isProcessing = true;
            
            try {
                const img = new Image();
                img.onload = async function() {
                    const tempCanvas = document.createElement('canvas');
                    const tempCtx = tempCanvas.getContext('2d');
                    tempCanvas.width = img.width;
                    tempCanvas.height = img.height;
                    tempCtx.drawImage(img, 0, 0);
                    
                    // ë” ê°•í™”ëœ ì´ë¯¸ì§€ ì „ì²˜ë¦¬
                    const processedImageData = preprocessForWreathEnhanced(tempCanvas, tempCtx);
                    
                    // ë‹¤ì¤‘ OCR ì‹œë„ë¡œ ì •í™•ë„ í–¥ìƒ
                    const recognitionPromises = [
                        // ì„¸ë¡œ í…ìŠ¤íŠ¸ ëª¨ë“œ
                        Tesseract.recognize(processedImageData, 'kor+chi_sim+chi_tra+eng', {
                            tessedit_pageseg_mode: Tesseract.PSM.SINGLE_BLOCK_VERT_TEXT,
                            tessedit_ocr_engine_mode: Tesseract.OEM.LSTM_ONLY,
                            logger: m => {
                                if (m.status === 'recognizing text') {
                                    showStatus(`ê³ ê¸‰ ì¸ì‹ ëª¨ë“œ (ì„¸ë¡œ) ${Math.round(m.progress * 100)}%`, 'processing');
                                }
                            }
                        }),
                        // ë‹¨ì¼ ì»¬ëŸ¼ ëª¨ë“œ
                        Tesseract.recognize(processedImageData, 'kor+chi_sim+chi_tra+eng', {
                            tessedit_pageseg_mode: Tesseract.PSM.SINGLE_COLUMN,
                            tessedit_ocr_engine_mode: Tesseract.OEM.LSTM_ONLY,
                            logger: m => {
                                if (m.status === 'recognizing text') {
                                    showStatus(`ê³ ê¸‰ ì¸ì‹ ëª¨ë“œ (ì»¬ëŸ¼) ${Math.round(m.progress * 100)}%`, 'processing');
                                }
                            }
                        })
                    ];

                    const results = await Promise.all(recognitionPromises);
                    
                    // ê°€ì¥ ê¸´ ê²°ê³¼ ì„ íƒ (ë³´í†µ ë” ì •í™•í•¨)
                    const bestResult = results.reduce((best, current) => 
                        current.data.text.length > best.data.text.length ? current : best
                    );

                    processWreathText(bestResult.data.text);
                    showStatus('âœ¨ ê³ ê¸‰ ì¸ì‹ ëª¨ë“œ ì™„ë£Œ! ê²°ê³¼ë¥¼ í™•ì¸í•˜ê³  í•„ìš”ì‹œ ìˆ˜ì •í•´ì£¼ì„¸ìš”.', 'success');
                    isProcessing = false;
                };
                img.src = imageData;
                
            } catch (error) {
                showStatus('ê³ ê¸‰ ì¸ì‹ ëª¨ë“œì—ì„œë„ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì¡°ëª…ì„ ë°ê²Œ í•˜ê³  ë‹¤ì‹œ ì´¬ì˜í•´ë³´ì„¸ìš”.', 'error');
                console.error('ê³ ê¸‰ OCR ì˜¤ë¥˜:', error);
                isProcessing = false;
            }
        }

        // í™”í™˜ ì „ìš© ì´ë¯¸ì§€ ì „ì²˜ë¦¬ (ê°•í™” ë²„ì „)
        function preprocessForWreath(canvas, ctx) {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            // í™”í™˜ ë¦¬ë³¸ í…ìŠ¤íŠ¸ ê°•ì¡°ë¥¼ ìœ„í•œ ì „ì²˜ë¦¬ ê°•í™”
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                
                // íšŒìƒ‰ì¡° ë³€í™˜
                const gray = r * 0.299 + g * 0.587 + b * 0.114;
                
                // ë” ê°•í•œ ëŒ€ë¹„ ì ìš©
                let enhanced;
                if (gray < 100) {
                    // ì–´ë‘ìš´ ë¶€ë¶„(í…ìŠ¤íŠ¸) ë” ì–´ë‘¡ê²Œ
                    enhanced = Math.max(0, gray * 0.2);
                } else if (gray > 180) {
                    // ë°ì€ ë¶€ë¶„(ë°°ê²½) ë” ë°ê²Œ  
                    enhanced = 255;
                } else {
                    // ì¤‘ê°„í†¤ ì²˜ë¦¬
                    enhanced = gray < 140 ? gray * 0.4 : Math.min(255, gray * 1.5);
                }
                
                data[i] = enhanced;     // Red
                data[i + 1] = enhanced; // Green
                data[i + 2] = enhanced; // Blue
            }
            
            ctx.putImageData(imageData, 0, 0);
            return canvas.toDataURL('image/png', 1.0);
        }

        // í–¥ìƒëœ ì´ë¯¸ì§€ ì „ì²˜ë¦¬
        function preprocessForWreathEnhanced(canvas, ctx) {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            // 1ë‹¨ê³„: ë…¸ì´ì¦ˆ ì œê±°ë¥¼ ìœ„í•œ í‰ê·  í•„í„°
            const filteredData = new Uint8ClampedArray(data);
            const width = canvas.width;
            const height = canvas.height;
            
            for (let y = 1; y < height - 1; y++) {
                for (let x = 1; x < width - 1; x++) {
                    const idx = (y * width + x) * 4;
                    
                    // 3x3 ì»¤ë„ í‰ê· 
                    let rSum = 0, gSum = 0, bSum = 0;
                    for (let dy = -1; dy <= 1; dy++) {
                        for (let dx = -1; dx <= 1; dx++) {
                            const nIdx = ((y + dy) * width + (x + dx)) * 4;
                            rSum += data[nIdx];
                            gSum += data[nIdx + 1];
                            bSum += data[nIdx + 2];
                        }
                    }
                    
                    filteredData[idx] = rSum / 9;
                    filteredData[idx + 1] = gSum / 9;
                    filteredData[idx + 2] = bSum / 9;
                }
            }
            
            // 2ë‹¨ê³„: ê°•í™”ëœ ëŒ€ë¹„ ì ìš©
            for (let i = 0; i < filteredData.length; i += 4) {
                const r = filteredData[i];
                const g = filteredData[i + 1];
                const b = filteredData[i + 2];
                
                const gray = r * 0.299 + g * 0.587 + b * 0.114;
                
                // ì´ì§„í™”ì— ê°€ê¹Œìš´ ê°•í•œ ëŒ€ë¹„
                const enhanced = gray < 120 ? 0 : 255;
                
                filteredData[i] = enhanced;
                filteredData[i + 1] = enhanced;
                filteredData[i + 2] = enhanced;
            }
            
            const enhancedImageData = new ImageData(filteredData, width, height);
            ctx.putImageData(enhancedImageData, 0, 0);
            return canvas.toDataURL('image/png', 1.0);
        }

        // í™”í™˜ í…ìŠ¤íŠ¸ ì²˜ë¦¬ (ì¢Œ/ìš° ë¦¬ë³¸ êµ¬ë¶„) - ê°•í™” ë²„ì „
        function processWreathText(text) {
            console.log('ì›ë³¸ í…ìŠ¤íŠ¸:', text);
            
            document.getElementById('recognizedText').value = text;
            
            // í…ìŠ¤íŠ¸ ì •ë¦¬
            const cleanedText = text
                .replace(/[^\w\sã„±-ã…ã…-ã…£ê°€-í£ä¸€-é¾¯ãˆœæ ªå¼ä¼šì‚¬().,!?\-_]/g, ' ')
                .replace(/\s+/g, ' ')
                .trim();
            
            // í…ìŠ¤íŠ¸ë¥¼ ì¤„ë³„ë¡œ ë¶„ë¦¬
            const lines = text.split(/[\n\r]+/)
                .filter(line => line.trim() !== '')
                .map(line => line.trim()
                    .replace(/[^\w\sã„±-ã…ã…-ã…£ê°€-í£ä¸€-é¾¯ãˆœæ ªå¼ä¼šì‚¬().,!?\-_]/g, ' ')
                    .replace(/\s+/g, ' ')
                    .trim()
                )
                .filter(line => line.length > 0);
            
            console.log('ì •ì œëœ ë¼ì¸ë“¤:', lines);
            
            // ì¢Œì¸¡/ìš°ì¸¡ ë¦¬ë³¸ êµ¬ë¶„ ë¡œì§ ê°•í™”
            let leftRibbon = '';
            let rightRibbon = '';
            
            // í™”í™˜ í‚¤ì›Œë“œ í™•ì¥
            const leftKeywords = [
                'ì¶•í•˜', 'ì‚¼ê°€', 'ê³ ì¸', 'ëª…ë³µ', 'ì¡°ì˜', 'ì• ë„', 'ì¶”ëª¨', 'ì˜ë©´', 'ì•ˆì‹',
                'ì¶•', 'ì¡°', 'å“€æ‚¼', 'è¿½æ…•', 'å†¥ç¦', 'å®‰æ¯', 'æ°¸çœ ', 'æ•…äºº',
                'ì¶•ë³µ', 'ê¸°ì›', 'ê¸°ë…', 'ê²½ì¶•', 'ê°œì—…', 'ê°œì ', 'ì°½ë¦½'
            ];
            const rightKeywords = [
                'ë“œë¦¼', 'ì˜¬ë¦¼', 'ì¼ë™', 'íšŒì‚¬', 'ê·¸ë£¹', 'ëŒ€í‘œ', 'ì‚¬ì¥', 'ãˆœ', 'ì£¼ì‹íšŒì‚¬',
                'æ ªå¼ä¼šç¤¾', 'ä»£è¡¨', 'ç¤¾é•·', 'ì„ì§ì›', 'ì§ì›', 'ê°€ì¡±', 'ì¹œêµ¬', 'ë™ë£Œ',
                'ìƒ', 'ë°°ìƒ', 'æ•¬ä¸Š', 'æ‹œä¸Š', 'è¬¹å¼”'
            ];
            
            const leftLines = [];
            const rightLines = [];
            const neutralLines = [];
            
            for (let line of lines) {
                if (line.length < 2) continue;
                
                const hasLeftKeyword = leftKeywords.some(keyword => line.includes(keyword));
                const hasRightKeyword = rightKeywords.some(keyword => line.includes(keyword));
                
                if (hasLeftKeyword && !hasRightKeyword) {
                    leftLines.push(line);
                } else if (hasRightKeyword && !hasLeftKeyword) {
                    rightLines.push(line);
                } else {
                    neutralLines.push(line);
                }
            }
            
            // ì¤‘ì„± ë¼ì¸ë“¤ì„ ê¸¸ì´ ê¸°ì¤€ìœ¼ë¡œ ë°°ë¶„
            for (let line of neutralLines) {
                if (leftLines.join(' ').length <= rightLines.join(' ').length) {
                    leftLines.push(line);
                } else {
                    rightLines.push(line);
                }
            }
            
            leftRibbon = leftLines.join(' ');
            rightRibbon = rightLines.join(' ');
            
            // ë§Œì•½ í•œìª½ì´ ë¹„ì–´ìˆë‹¤ë©´ ì „ì²´ í…ìŠ¤íŠ¸ë¥¼ ë°˜ë°˜ ë‚˜ëˆ„ê¸°
            if (!leftRibbon && rightRibbon) {
                const words = rightRibbon.split(' ');
                const mid = Math.ceil(words.length / 2);
                leftRibbon = words.slice(0, mid).join(' ');
                rightRibbon = words.slice(mid).join(' ');
            } else if (leftRibbon && !rightRibbon) {
                const words = leftRibbon.split(' ');
                const mid = Math.ceil(words.length / 2);
                rightRibbon = words.slice(mid).join(' ');
                leftRibbon = words.slice(0, mid).join(' ');
            }
            
            document.getElementById('leftRibbon').value = leftRibbon;
            document.getElementById('rightRibbon').value = rightRibbon;
            
            document.getElementById('resultSection').classList.remove('hidden');
        }

        // ì—°ê²° í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ (ê°•í™”ëœ ì˜¤ë¥˜ ì²˜ë¦¬)
        async function testConnection() {
            showStatus('í™”í™˜ ì›¹ì•± ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...', 'processing');
            
            try {
                console.log('í…ŒìŠ¤íŠ¸ URL:', WEBAPP_URL);
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10ì´ˆ íƒ€ì„ì•„ì›ƒ
                
                const response = await fetch(WEBAPP_URL + '?test=true&_=' + Date.now(), {
                    method: 'GET',
                    mode: 'cors',
                    cache: 'no-cache',
                    signal: controller.signal,
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                clearTimeout(timeoutId);
                
                console.log('ì‘ë‹µ ìƒíƒœ:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('í…ŒìŠ¤íŠ¸ ê²°ê³¼:', result);
                
                if (result.success) {
                    showStatus(`âœ… ì—°ê²° ì„±ê³µ! ì‹œíŠ¸: ${result.sheetName || 'N/A'}, í™”í™˜ ë°ì´í„°: ${result.totalRows || 0}ê°œ`, 'success');
                } else {
                    showStatus(`âŒ ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ${result.message}`, 'error');
                }
                
            } catch (error) {
                console.error('ì—°ê²° í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜:', error);
                
                if (error.name === 'AbortError') {
                    showStatus('âŒ ì—°ê²° ì‹œê°„ ì´ˆê³¼: ì›¹ì•± URLì„ í™•ì¸í•˜ê±°ë‚˜ ìƒˆë¡œ ë°°í¬í•´ì£¼ì„¸ìš”.', 'error');
                } else if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                    showStatus('âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ì¸í„°ë„· ì—°ê²°ê³¼ ì›¹ì•± URLì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');
                } else if (error.message.includes('CORS')) {
                    showStatus('âŒ CORS ì˜¤ë¥˜: Apps Scriptë¥¼ ìƒˆë¡œ ë°°í¬í•´ì£¼ì„¸ìš”.', 'error');
                } else {
                    showStatus(`âŒ ì—°ê²° ì‹¤íŒ¨: ${error.message}`, 'error');
                }
            }
        }

        // ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì €ì¥ (ê°•í™”ëœ ì˜¤ë¥˜ ì²˜ë¦¬ ë° ì¬ì‹œë„)
        async function saveToSheets(retryCount = 0) {
            const data = {
                timestamp: new Date().toLocaleString('ko-KR', {
                    timeZone: 'Asia/Seoul',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                }),
                leftRibbon: document.getElementById('leftRibbon').value.trim(),
                rightRibbon: document.getElementById('rightRibbon').value.trim(),
                recognizedText: document.getElementById('recognizedText').value.trim()
            };
            
            // ë°ì´í„° ê²€ì¦
            if (!data.leftRibbon && !data.rightRibbon && !data.recognizedText) {
                showStatus('ì €ì¥í•  í™”í™˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € í…ìŠ¤íŠ¸ë¥¼ ì¸ì‹í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            // ë¡œì»¬ ì €ì¥
            savedData.unshift(data); // ìµœì‹  ë°ì´í„°ë¥¼ ì•ì— ì¶”ê°€
            if (savedData.length > 50) { // ìµœëŒ€ 50ê°œë§Œ ë³´ê´€
                savedData = savedData.slice(0, 50);
            }
            localStorage.setItem('wreathData', JSON.stringify(savedData));
            updateDataList();
            
            try {
                showStatus('í™”í™˜ ì •ë³´ë¥¼ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì— ì €ì¥ ì¤‘...', 'processing');
                
                console.log('í™”í™˜ ë°ì´í„° ì €ì¥ ì‹œë„:', {
                    url: WEBAPP_URL,
                    data: data,
                    attempt: retryCount + 1
                });
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000); // 15ì´ˆ íƒ€ì„ì•„ì›ƒ
                
                const response = await fetch(WEBAPP_URL + '?_=' + Date.now(), {
                    method: 'POST',
                    mode: 'cors',
                    cache: 'no-cache',
                    signal: controller.signal,
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                clearTimeout(timeoutId);
                
                console.log('ì €ì¥ ì‘ë‹µ ìƒíƒœ:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('ì €ì¥ ê²°ê³¼:', result);
                
                if (result.success) {
                    showStatus(`âœ… í™”í™˜ ì •ë³´ ì €ì¥ ì™„ë£Œ! (í–‰: ${result.rowNumber || 'N/A'})`, 'success');
                    
                    // í¼ ì´ˆê¸°í™”
                    document.getElementById('leftRibbon').value = '';
                    document.getElementById('rightRibbon').value = '';
                    document.getElementById('recognizedText').value = '';
                    document.getElementById('resultSection').classList.add('hidden');
                    
                    // ë‹¤ì‹œ ì´¬ì˜ ì¤€ë¹„
                    setTimeout(() => {
                        showStatus('ìƒˆë¡œìš´ í™”í™˜ì„ ì´¬ì˜í•  ì¤€ë¹„ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    }, 2000);
                    
                } else {
                    throw new Error(result.message || result.error || 'ì €ì¥ ì‹¤íŒ¨');
                }
                
            } catch (error) {
                console.error('ì €ì¥ ì˜¤ë¥˜:', error);
                
                // ì¬ì‹œë„ ë¡œì§ (ìµœëŒ€ 2íšŒ)
                if (retryCount < 2 && (
                    error.name === 'AbortError' || 
                    error.name === 'TypeError' ||
                    error.message.includes('network')
                )) {
                    console.log(`ì¬ì‹œë„ ì¤‘... (${retryCount + 1}/2)`);
                    showStatus(`ì €ì¥ ì¬ì‹œë„ ì¤‘... (${retryCount + 2}/3)`, 'processing');
                    
                    setTimeout(() => {
                        saveToSheets(retryCount + 1);
                    }, 2000);
                    return;
                }
                
                // ì˜¤ë¥˜ ë©”ì‹œì§€ ê°œì„ 
                if (error.name === 'AbortError') {
                    showStatus('âŒ ì €ì¥ ì‹œê°„ ì´ˆê³¼: ë„¤íŠ¸ì›Œí¬ ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');
                } else if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                    showStatus('âŒ ë„¤íŠ¸ì›Œí¬ ì—°ê²° ì‹¤íŒ¨: ì¸í„°ë„· ì—°ê²°ê³¼ ì›¹ì•± URLì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');
                } else if (error.message.includes('CORS')) {
                    showStatus('âŒ CORS ì˜¤ë¥˜: Apps Scriptë¥¼ ìƒˆë¡œ ë°°í¬í•´ì£¼ì„¸ìš”.', 'error');
                } else {
                    showStatus(`âŒ ì €ì¥ ì‹¤íŒ¨: ${error.message}`, 'error');
                }
                
                // ë¡œì»¬ì—ëŠ” ì €ì¥ë˜ì—ˆìŒì„ ì•Œë¦¼
                setTimeout(() => {
                    showStatus('ğŸ’¾ ë¡œì»¬ ì €ì¥ì€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ í™•ì¸ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'success');
                }, 3000);
            }
        }

        // ìƒíƒœ í‘œì‹œ (í–¥ìƒëœ ë²„ì „)
        function showStatus(message, type) {
            const statusEl = document.getElementById('status');
            statusEl.className = `status ${type}`;
            statusEl.classList.remove('hidden');
            
            if (type === 'processing') {
                statusEl.innerHTML = '<span class="loading"></span>' + message;
            } else {
                statusEl.textContent = message;
            }
            
            // ì„±ê³µ/ì˜¤ë¥˜ ë©”ì‹œì§€ëŠ” 5ì´ˆ í›„ ìë™ìœ¼ë¡œ ìˆ¨ê¹€
            if (type === 'success' || type === 'error') {
                setTimeout(() => {
                    if (statusEl.textContent === message) {
                        statusEl.classList.add('hidden');
                    }
                }, 5000);
            }
        }

        // ì €ì¥ëœ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        function loadSavedData() {
            const saved = localStorage.getItem('wreathData');
            if (saved) {
                try {
                    savedData = JSON.parse(saved);
                    updateDataList();
                } catch (error) {
                    console.error('ë¡œì»¬ ë°ì´í„° ë¡œë”© ì˜¤ë¥˜:', error);
                    savedData = [];
                }
            }
        }

        // ë°ì´í„° ëª©ë¡ ì—…ë°ì´íŠ¸ (í™”í™˜ ì „ìš©)
        function updateDataList() {
            const savedItems = document.getElementById('savedItems');
            savedItems.innerHTML = '';
            
            if (savedData.length === 0) {
                savedItems.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 25px; background: #f8f9fa; border-radius: 8px;">ì €ì¥ëœ í™”í™˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.<br><small>ì´¬ì˜ í›„ ì €ì¥í•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</small></p>';
                return;
            }
            
            // ìµœì‹  5ê°œë§Œ í‘œì‹œ
            const recentData = savedData.slice(0, 5);
            
            recentData.forEach((item, index) => {
                const itemEl = document.createElement('div');
                itemEl.className = 'data-item';
                itemEl.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <strong>ğŸŒ¸ í™”í™˜ ì •ë³´ #${index + 1}</strong>
                        <small style="color: #6c757d;">${item.timestamp}</small>
                    </div>
                    <div style="margin-top: 10px;">
                        <div style="background: #e3f2fd; padding: 8px; border-radius: 6px; margin-bottom: 6px; border-left: 3px solid #2196f3;">
                            <strong>ì¢Œì¸¡:</strong> ${item.leftRibbon || '(ì—†ìŒ)'}
                        </div>
                        <div style="background: #f3e5f5; padding: 8px; border-radius: 6px; border-left: 3px solid #9c27b0;">
                            <strong>ìš°ì¸¡:</strong> ${item.rightRibbon || '(ì—†ìŒ)'}
                        </div>
                    </div>
                `;
                savedItems.appendChild(itemEl);
            });
            
            if (savedData.length > 5) {
                const moreInfo = document.createElement('p');
                moreInfo.style.cssText = 'text-align: center; color: #6c757d; margin-top: 10px; font-size: 12px;';
                moreInfo.textContent = `ì™¸ ${savedData.length - 5}ê°œì˜ ë°ì´í„°ê°€ ë” ìˆìŠµë‹ˆë‹¤.`;
                savedItems.appendChild(moreInfo);
            }
        }

        // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì¹´ë©”ë¼ ì •ë¦¬
        window.addEventListener('beforeunload', function() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }
        });

        // í˜ì´ì§€ visibility ë³€ê²½ ì‹œ ì¹´ë©”ë¼ ê´€ë¦¬
        document.addEventListener('visibilitychange', function() {
            if (currentStream) {
                if (document.hidden) {
                    // í˜ì´ì§€ê°€ ìˆ¨ê²¨ì§€ë©´ ì¹´ë©”ë¼ ì¼ì‹œì •ì§€
                    currentStream.getVideoTracks().forEach(track => track.enabled = false);
                } else {
                    // í˜ì´ì§€ê°€ ë‹¤ì‹œ ë³´ì´ë©´ ì¹´ë©”ë¼ ì¬ê°œ
                    currentStream.getVideoTracks().forEach(track => track.enabled = true);
                }
            }
        });
    </script>
</body>
</html>
